# encoding: utf-8
from Calf import BaseModel
from Calf.base.query_str_analyzer import analyzer
from Calf.data import signaldata
from Calf.models import Calendar
import pandas as pd


class KlineBase:
    @classmethod
    def get_time_index(cls, time, category=5, off=1):
        _5 = [935, 940, 945, 950, 955, 1000, 1005, 1010, 1015, 1020, 1025, 1030, 1035, 1040, 1045,
              1050, 1055, 1100, 1105, 1110, 1115, 1120, 1125, 1130, 1305, 1310, 1315, 1320, 1325, 1330, 1335,
              1340, 1345, 1350, 1355, 1400, 1405, 1410, 1415,
              1420, 1425, 1430, 1435, 1440, 1445, 1450, 1455, 1500]
        _15 = [945, 1000, 1015, 1030, 1045, 1100, 1115, 1130, 1315, 1330, 1345, 1400, 1415, 1430, 1445, 1500]
        _30 = [1000, 1030, 1100, 1130, 1330, 1400, 1430, 1500]
        _60 = [1030, 1130, 1400, 1500]
        mapping = {'5': _5, '15': _15, '30': _30, '60': _60}
        time_list = mapping[str(category)]
        if time == 935 and off == -1:
            raise Exception("9：35前0数据")
        elif time == 1500 and off == 1:
            raise Exception("15：00后0数据")
        for ti in range(len(time_list)):
            if time_list[ti] == time:
                return time_list[ti + off]

    @classmethod
    def get_all_stock_code_info(cls, date=None, time=None, kline='kline_min5'):
        sql = analyzer('date = {} and time = {}'.format(date, time))
        data = pd.DataFrame(list(BaseModel(kline).query(sql)))
        if len(data) == 0:
            return pd.DataFrame()
        data['pro'] = data.close / data.open - 1
        #以上是把数据从数据库中取出
        #并且求出各个时刻的收益
        #注意，如果要求收益的计算方式close/pre_close-1,则close需要通过shift()调整
        data2 = None
        if time == 1500:
            #如果time是1500，需要把明天的第一根取出来计算
            x = Calendar.calc(analyzer('date = {}'.format(date))['date'], 1)['date']
            sql = analyzer(
                'date = {} and time = {}'.format(str(x.year * 10000 + x.month * 100 + x.day), 935))
            data2 = pd.DataFrame(list(BaseModel(kline).query(sql)))
            if len(data2) == 0:
                return pd.DataFrame()
            data = pd.merge(data, data2, on='stock_code')
            data['profit'] = (data.close_y / data.close_x - 1)
            return data.loc[:, ['stock_code', 'date_x', 'time_x', 'profit', 'pro']]
        else:
            time_index = KlineBase.get_time_index(time)
            sql = analyzer('date = {} and time = {}'.format(date, time_index))
            data2 = pd.DataFrame(list(BaseModel(kline).query(sql)))
            if len(data2) == 0:
                return pd.DataFrame()
            data = pd.merge(data, data2, on='stock_code')
            data['profit'] = (data.close_y / data.close_x - 1)
            return data.loc[:, ['stock_code', 'date_x', 'time_x', 'profit', 'pro']]

    @classmethod
    def get_all_stock_code_info_for_day(cls, start_date, end_date, kline='kline_day'):
        #day数据不同于日内数据
        sql = {'date': {'$gte': start_date, '$lte': end_date}}
        data = pd.DataFrame(list(BaseModel(kline).query(sql)))
        #以上操作是将数据从数据库中获取
        if len(data) == 0:
            return pd.DataFrame()
        after_data = data[data.date == end_date]
        before_data = data[data.date == start_date]
        data = pd.merge(before_data, after_data, on=['stock_code'])
        data['pro'] = data.close_x / data.open_x - 1
        data['profit'] = data.close_y / data.close_x - 1
        # print(data.head())
        # print(data.head())
        return data.loc[:, ['stock_code', 'date_x', 'profit', 'pro']]

    @classmethod
    def get_all_info(cls, start_date, end_date, kline='kline_day'):
        #不限定股票，条件为时间范围、kline
        sql = {'date': {'$gte': start_date, '$lte': end_date}}
        data = pd.DataFrame(list(BaseModel(kline).query(sql)))
        if len(data) == 0:
            return pd.DataFrame()
        data.to_csv('f://hhh.csv')
        #这里可通过文件存储起来，或者存到数据库中

    @classmethod
    def get_all_min5_info(cls, start_date, end_date, kline='index_min5'):
        sql = {'date': {'$gte': start_date, '$lte': end_date}}
        data = pd.DataFrame(list(BaseModel(kline).query(sql)))
        if len(data) == 0:
            return pd.DataFrame()
        data = signaldata.merge_time(data)
        # data=pd.DataFrame()
        data = data.sort_values(by=['date'], ascending=True)
        return data

    @classmethod
    def get_all_plate_code(cls):
        #数据库中的行业板块、指数
        index_list = ['399001', '399106', '399005', '399101', '399006', '399102', '399303', '000001', '000300',
                      '000905', '000016',
                      "880201",
                      "880202",
                      "880203",
                      "880204",
                      "880205",
                      "880206",
                      "880207",
                      "880208",
                      "880209",
                      "880210",
                      "880211",
                      "880212",
                      "880213",
                      "880214",
                      "880215",
                      "880216",
                      "880217",
                      "880218",
                      "880219",
                      "880220",
                      "880221",
                      "880222",
                      "880223",
                      "880224",
                      "880225",
                      "880226",
                      "880227",
                      "880228",
                      "880229",
                      "880230",
                      "880231",
                      "880232",
                      "880301",
                      "880302",
                      "880303",
                      "880305",
                      "880306",
                      "880307",
                      "880308",
                      "880310",
                      "880311",
                      "880312",
                      "880313",
                      "880318",
                      "880319",
                      "880320",
                      "880321",
                      "880324",
                      "880325",
                      "880326",
                      "880327",
                      "880328",
                      "880329",
                      "880330",
                      "880335",
                      "880336",
                      "880337",
                      "880338",
                      "880339",
                      "880340",
                      "880344",
                      "880345",
                      "880346",
                      "880347",
                      "880348",
                      "880350",
                      "880351",
                      "880355",
                      "880360",
                      "880361",
                      "880362",
                      "880363",
                      "880364",
                      "880366",
                      "880367",
                      "880368",
                      "880369",
                      "880372",
                      "880373",
                      "880374",
                      "880375",
                      "880380",
                      "880381",
                      "880382",
                      "880383",
                      "880387",
                      "880390",
                      "880391",
                      "880392",
                      "880393",
                      "880394",
                      "880398",
                      "880399",
                      "880400",
                      "880401",
                      "880402",
                      "880403",
                      "880406",
                      "880407",
                      "880408",
                      "880409",
                      "880410",
                      "880411",
                      "880412",
                      "880413",
                      "880414",
                      "880418",
                      "880419",
                      "880420",
                      "880421",
                      "880422",
                      "880423",
                      "880424",
                      "880425",
                      "880426",
                      "880430",
                      "880431",
                      "880432",
                      "880437",
                      "880438",
                      "880439",
                      "880440",
                      "880441",
                      "880442",
                      "880443",
                      "880444",
                      "880445",
                      "880446",
                      "880447",
                      "880448",
                      "880452",
                      "880453",
                      "880454",
                      "880455",
                      "880456",
                      "880459",
                      "880460",
                      "880461",
                      "880462",
                      "880463",
                      "880464",
                      "880465",
                      "880466",
                      "880467",
                      "880468",
                      "880471",
                      "880472",
                      "880473",
                      "880474",
                      "880476",
                      "880477",
                      "880478",
                      "880482",
                      "880483",
                      "880484",
                      "880485",
                      "880486",
                      "880489",
                      "880490",
                      "880491",
                      "880492",
                      "880493",
                      "880494",
                      "880497",
                      "880501",
                      "880502",
                      "880503",
                      "880504",
                      "880505",
                      "880506",
                      "880507",
                      "880511",
                      "880513",
                      "880515",
                      "880516",
                      "880519",
                      "880520",
                      "880521",
                      "880522",
                      "880523",
                      "880524",
                      "880525",
                      "880526",
                      "880527",
                      "880528",
                      "880529",
                      "880530",
                      "880531",
                      "880532",
                      "880533",
                      "880534",
                      "880535",
                      "880536",
                      "880537",
                      "880538",
                      "880539",
                      "880540",
                      "880541",
                      "880542",
                      "880543",
                      "880544",
                      "880545",
                      "880546",
                      "880547",
                      "880548",
                      "880549",
                      "880550",
                      "880551",
                      "880552",
                      "880553",
                      "880554",
                      "880556",
                      "880557",
                      "880558",
                      "880559",
                      "880560",
                      "880562",
                      "880563",
                      "880564",
                      "880565",
                      "880566",
                      "880567",
                      "880568",
                      "880569",
                      "880570",
                      "880571",
                      "880572",
                      "880573",
                      "880574",
                      "880575",
                      "880576",
                      "880577",
                      "880578",
                      "880579",
                      "880580",
                      "880581",
                      "880582",
                      "880583",
                      "880584",
                      "880585",
                      "880586",
                      "880587",
                      "880588",
                      "880589",
                      "880590",
                      "880591",
                      "880592",
                      "880593",
                      "880594",
                      "880595",
                      "880596",
                      "880597",
                      "880598",
                      "880599",
                      "880600",
                      "880601",
                      "880602",
                      "880603",
                      "880604",
                      "880605",
                      "880606",
                      "880607",
                      "880608",
                      "880609",
                      "880610",
                      "880612",
                      "880613",
                      "880614",
                      "880615",
                      "880616",
                      "880617",
                      "880618",
                      "880619",
                      "880620",
                      "880621",
                      "880622",
                      "880623",
                      "880624",
                      "880625",
                      "880626",
                      "880627",
                      "880628",
                      "880629",
                      "880630",
                      "880631",
                      "880632",
                      "880633",
                      "880634",
                      "880635",
                      "880636",
                      "880637",
                      "880638",
                      "880639",
                      "880640",
                      "880641",
                      "880642",
                      "880643",
                      "880644",
                      "880645",
                      "880646",
                      "880647",
                      "880648",
                      "880649",
                      "880650",
                      "880651",
                      "880652",
                      "880653",
                      "880654",
                      "880655",
                      "880656",
                      "880657",
                      "880658",
                      "880659",
                      "880660",
                      "880661",
                      "880662",
                      "880663",
                      "880664",
                      "880665",
                      "880666",
                      "880667",
                      "880668",
                      "880669",
                      "880670",
                      "880671",
                      "880672",
                      "880673",
                      "880674",
                      "880675",
                      "880676",
                      "880677",
                      "880678",
                      "880679",
                      "880680",
                      "880681",
                      "880682",
                      "880683",
                      "880684",
                      "880685",
                      "880801",
                      "880802",
                      "880803",
                      "880804",
                      "880805",
                      "880806",
                      "880807",
                      "880808",
                      "880809",
                      "880821",
                      "880823",
                      "880824",
                      "880826",
                      "880827",
                      "880829",
                      "880833",
                      "880834",
                      "880835",
                      "880836",
                      "880837",
                      "880842",
                      "880843",
                      "880844",
                      "880845",
                      "880846",
                      "880847",
                      "880848",
                      "880849",
                      "880850",
                      "880851",
                      "880852",
                      "880853",
                      "880854",
                      "880855",
                      "880856",
                      "880857",
                      "880858",
                      "880859",
                      "880860",
                      "880861",
                      "880862",
                      "880863",
                      "880864",
                      "880865",
                      "880866",
                      "880867",
                      "880868",
                      "880869",
                      "880870",
                      "880871",
                      "880872",
                      "880873",
                      "880874",
                      "880875",
                      "880876",
                      "880877",
                      "880878",
                      "880879",
                      "880880",
                      "880881",
                      "880882",
                      "880883",
                      "880884",
                      "880885",
                      "880886",
                      "880887",
                      "880889",
                      "880890",
                      "880901",
                      "880902",
                      "880903",
                      "880904",
                      "880905",
                      "880906",
                      "880907",
                      "880908",
                      "880909",
                      "880910",
                      "880911",
                      "880912",
                      "880913",
                      "880915",
                      "880916",
                      "880917",
                      "880918",
                      "880919",
                      "880920",
                      "880921",
                      "880922",
                      "880923",
                      "880925",
                      "880926",
                      "880927",
                      "880928",
                      "880929",
                      "880930",
                      "880931",
                      "880932",
                      "880933",
                      "880935",
                      "880936",
                      "880937",
                      "880938",
                      "880939",
                      "880940",
                      "880941",
                      "880942",
                      "880943",
                      "880944",
                      "880945",
                      "880946",
                      "880947",
                      "880948",
                      "880949",
                      "880950",
                      "880951",
                      "880952",
                      "880953",
                      "880954",
                      "880981",
                      "880982",
                      "880983",
                      "880984",
                      "880985",
                      "880986",
                      "880987",
                      "880988",
                      "880989",
                      "880990",
                      "880991",
                      "880992",
                      "880993"
                      ]
        return index_list

